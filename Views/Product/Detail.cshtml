@using EbayChat.Entities;
@using EbayChat.Models.ViewModel;
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@{


	var product = ViewBag.Product as Product;
	var category = product?.category;
	var sellerInfo = ViewBag.SellerInfo as SellerInfoViewModel;
	var userId = HttpContextAccessor.HttpContext?.Session.GetInt32("userId");
	var canReview = ViewBag.CanReview as bool? ?? false; // do Controller gửi sang
	var productReviews = ViewBag.Reviews as List<ReviewViewModel>;
	ViewData["Title"] = product?.title + " Page";
}

<nav aria-label="breadcrumb">
	<ol class="breadcrumb">
		<li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">eBay</a></li>
		<li class="breadcrumb-item">
			<a asp-controller="Product" asp-action="Index" asp-route-categoryId="@category.id">@category.name</a>
		</li>
		<li class="breadcrumb-item active" aria-current="page">@product.title</li>
	</ol>
</nav>

<div class="container mt-4">
	<div class="row">
		<!-- LEFT: Product Image -->
		<div class="col-md-6">
			<img src="@product.images" class="img-fluid border rounded" alt="@product.title" />
		</div>

		<!-- RIGHT: Product Info -->
		<div class="col-md-6">
			<h2>@product.title</h2>
			<p class="text-muted">@product.category.name</p>

			@if (sellerInfo != null)
			{
				<div class="card my-4" data-bs-toggle="modal" data-bs-target="#sellerInfo" style="cursor: pointer;">
					<div class="card-body">
						<div class="d-flex align-items-center">
							<img src="@(sellerInfo.SellerAvatar ?? "https://sgt.edu.vn/wp-content/uploads/2025/07/user-avatar.png")" alt="Seller Avatar"
								 class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;" />
							<div class="flex-grow-1">
								<h5 class="card-title mb-0">
									@sellerInfo.SellerUsername
									<span class="text-muted">(@(sellerInfo.Reviews == null ? 0 : sellerInfo.Reviews.Count) reviews)</span>
								</h5>
							</div>
							<h2 class="text-muted">
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lightbulb-fill" viewBox="0 0 16 16">
									<path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13h-5a.5.5 0 0 1-.46-.302l-.761-1.77a2 2 0 0 0-.453-.618A5.98 5.98 0 0 1 2 6m3 8.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1-.5-.5" />
								</svg>
							</h2>
						</div>
					</div>
				</div>
			}

			<h4 class="text-danger">$@product.price</h4>
			<p>@product.description</p>

			<form method="post">
				<div class="d-flex align-items-center mb-3">
					<button type="button" class="btn btn-primary me-2"
							disabled="@(userId == sellerInfo.SellerId || userId == 0 || userId == null)">
						<i class="bi bi-cart"></i> Add to Cart
					</button>

					<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#buyNowModal"
							disabled="@(userId == sellerInfo.SellerId || userId == 0 || userId == null)">
						<i class="bi bi-lightning-charge-fill"></i> Buy Now
					</button>
				</div>
			</form>
		</div>
	</div>

	<hr class="my-5" />

	<!-- PRODUCT REVIEWS -->
	<div class="mt-4">
		<!-- Write a Review -->
		@if (userId != null && canReview)
		{
			<div class="mt-4 border p-3 rounded bg-light">
				<h5>Write a Review</h5>
				<form asp-controller="Product" asp-action="SubmitReview" method="post">
					<input type="hidden" name="productId" value="@product.id" />
					<input type="hidden" id="ratingInput" name="rating" value="0" />

					<div class="mb-3">
						<label class="form-label d-block">Rating</label>
						<div id="starRating" class="d-flex gap-1" style="cursor: pointer;">
							@for (int i = 1; i <= 5; i++)
							{
								<svg data-value="@i" xmlns="http://www.w3.org/2000/svg" width="28" height="28"
									 fill="none" stroke="currentColor"
									 class="star bi bi-star text-warning" viewBox="0 0 16 16">
									<path d="M2.866 14.85c-.078.444.36.791.746.593L8
                                13.187l4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73
                                3.522-3.356c.33-.314.159-.888-.282-.95l-4.898-.696L8.465.792a.513.513
                                0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.282.95l3.522
                                3.356-.83 4.73z" />
								</svg>
							}
						</div>
					</div>

					<div class="mb-3">
						<label class="form-label">Comment</label>
						<textarea name="comment" class="form-control" rows="3"
								  placeholder="Share your experience..." required></textarea>
					</div>

					<button type="submit" class="btn btn-primary">Submit Review</button>
				</form>
			</div>
		}
		else if (userId != null)
		{
			<div class="alert alert-info mt-3">
				You are not allowed to write a new review.
			</div>
		}
		<hr />
		<h4>Customer Reviews</h4>

		<!-- Average Rating -->
		@if (productReviews != null && productReviews.Count > 0)
		{
			var avg = productReviews.Average(r => r.Rating);
			var fullStars = (int)Math.Floor(avg);
			var hasHalfStar = (avg - fullStars) >= 0.25 && (avg - fullStars) < 0.75;
			var emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
			<div class="d-flex align-items-center mb-3">
				<div class="me-2 fw-semibold">Average Rating:</div>
				<div class="d-flex align-items-center">
					@for (int i = 0; i < fullStars; i++)
					{
						<!-- Full star -->
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
							 class="bi bi-star-fill text-warning" viewBox="0 0 16 16">
							<path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173
                    6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927
                    0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522
                    3.356.83 4.73c.078.443-.36.79-.746.592L8
                    13.187l-4.389 2.256z" />
						</svg>
					}

					@if (hasHalfStar)
					{
						<!-- Half star -->
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
							 class="bi bi-star-half text-warning" viewBox="0 0 16 16">
							<path d="M5.354 5.119 8 0.792l2.646 4.327 4.898.696-3.522
                    3.356.83 4.73L8 13.187V2.223l-.691 1.37-4.898.696z" />
						</svg>
					}

					@for (int i = 0; i < emptyStars; i++)
					{
						<!-- Empty star -->
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
							 fill="none" stroke="currentColor"
							 class="bi bi-star text-warning opacity-50" viewBox="0 0 16 16">
							<path d="M2.866 14.85c-.078.444.36.791.746.593L8
                    13.187l4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73
                    3.522-3.356c.33-.314.159-.888-.282-.95l-4.898-.696L8.465.792a.513.513
                    0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.282.95l3.522
                    3.356-.83 4.73z" />
						</svg>
					}

					<span class="ms-2 text-muted">(@avg.ToString("0.0") / 5)</span>
				</div>
			</div>
		}

		<!-- Review List -->
		@if (productReviews == null || productReviews.Count == 0)
		{
			<div class="alert alert-light border mt-3">No reviews yet.</div>
		}
		else
		{
			<ul class="list-group list-group-flush mt-2">
				@foreach (var r in productReviews)
				{
					<li class="list-group-item px-0">
						<div class="d-flex justify-content-between align-items-center">
							<strong>@r.ReviewerName</strong>
							<small class="text-muted">@r.CreatedAt?.ToString("dd/MM/yyyy")</small>
						</div>
						<p class="mb-1">
							@if (r?.Rating != null)
							{
								for (int i = 0; i < r.Rating; i++)
								{
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
										 fill="currentColor" class="bi bi-star-fill text-warning" viewBox="0 0 16 16">
										<path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173
                                    6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927
                                    0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522
                                    3.356.83 4.73c.078.443-.36.79-.746.592L8
                                    13.187l-4.389 2.256z" />
									</svg>
								}
							}
							else
							{
								<i>No rating</i>
							}
						</p>
						<p class="mb-1">@r.Comment</p>
						<small class="text-success">Verified purchase</small>
					</li>
				}
			</ul>
		}

		
	</div>
</div>

<!-- SELLER MODAL -->
<div class="modal fade" id="sellerInfo" tabindex="-1" role="dialog" aria-labelledby="sellerInfo" aria-hidden="true">
	<div class="modal-dialog modal-xl" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">About this seller</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="row">
					<div class="col-md-5 border-end">
						<div class="d-flex align-items-center mb-3">
							<img src="@(sellerInfo.SellerAvatar ?? "https://sgt.edu.vn/wp-content/uploads/2025/07/user-avatar.png")"
								 alt="Seller"
								 class="rounded-circle me-3"
								 style="width: 60px; height: 60px; object-fit: cover;" />
							<div>
								<h5 class="mb-0">@sellerInfo.SellerUsername</h5>
								<small class="text-danger">
									@(sellerInfo.PositiveRate != 0 ? $"{sellerInfo.PositiveRate}% positive feedback" : "No feedback data")
								</small>
							</div>
						</div>

						<p class="text-muted mb-1">
							<i class="bi bi-star-fill me-1 text-warning"></i>
							Average Rating:
							<span class="fw-bold">
								@(sellerInfo?.AverageRate != 0 ? sellerInfo?.AverageRate?.ToString("0.0") : "N/A")
							</span>
						</p>
						<p class="text-muted mb-1">
							<i class="bi bi-chat-left-quote-fill me-1 text-info"></i>
							Total Reviews:
							<span class="fw-bold">
								@(sellerInfo?.TotalReviews ?? 0)
							</span>
						</p>
						<div class="d-grid gap-2 mt-3">
							<a href="#" class="btn btn-primary">Visit store</a>
							<a href="#" class="btn btn-outline-secondary">Contact</a>
						</div>
					</div>

					<div class="col-md-7">
						<h6>Seller feedback</h6>

						@if (sellerInfo.Reviews == null || sellerInfo.Reviews.Count == 0)
						{
							<div class="alert alert-light border mt-3">No feedback yet.</div>
						}
						else
						{
							<ul class="list-group list-group-flush mt-2">
								@foreach (var review in sellerInfo.Reviews)
								{
									<li class="list-group-item px-0">
										<div class="d-flex w-100 justify-content-between">
											<div>
												<i class="bi bi-star-fill text-warning"></i>
												<strong class="ms-1">@review.ReviewerName</strong>
											</div>
											<small class="text-muted">@review.CreatedAt?.ToString("dd/MM/yyyy")</small>
										</div>
										<p class="mb-1">
											@(string.IsNullOrEmpty(review.Comment)
																					? "<i>No comment provided.</i>"
																					: review.Comment)
										</p>
										<small class="text-success">Verified purchase</small>
									</li>
								}
							</ul>
						}
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<!-- BUY NOW MODAL -->
<div class="modal fade" id="buyNowModal" tabindex="-1" aria-labelledby="buyNowModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Confirm Purchase</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>

			<form asp-controller="Order" asp-action="BuyNow" method="post">
				<div class="modal-body">
					<input type="hidden" name="productId" value="@product.id" />

					<div class="mb-3">
						<label>Quantity</label>
						<input type="number" name="quantity" value="1" min="1" class="form-control" required />
					</div>

					<div class="mb-3">
						<label>Full name</label>
						<input type="text" name="fullName" class="form-control" required />
					</div>

					<div class="mb-3">
						<label>Phone</label>
						<input type="text" name="phone" class="form-control" required />
					</div>

					<div class="mb-3">
						<label>Address</label>
						<textarea name="street" class="form-control" required></textarea>
					</div>

					<div class="mb-3">
						<label>City</label>
						<input type="text" name="city" class="form-control" required />
					</div>
					<div class="mb-3">
						<label>State</label>
						<input type="text" name="state" class="form-control" required />
					</div>
					<div class="mb-3">
						<label>Country</label>
						<input type="text" name="country" class="form-control" required />
					</div>
				</div>

				<div class="modal-footer">
					<button type="submit" class="btn btn-success">Confirm Purchase</button>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				</div>
			</form>
		</div>
	</div>
</div>

@section Scripts {
	<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

	@if (TempData["ErrorMessage"] != null)
	{
		<script>toastr.error("@TempData["ErrorMessage"]");</script>
	}
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const stars = document.querySelectorAll('#starRating .star');
			const ratingInput = document.getElementById('ratingInput');
			let currentRating = 0;

			stars.forEach(star => {
				star.addEventListener('mouseenter', () => highlightStars(star.dataset.value));
				star.addEventListener('mouseleave', () => highlightStars(currentRating));
				star.addEventListener('click', () => {
					currentRating = star.dataset.value;
					ratingInput.value = currentRating;
					highlightStars(currentRating);
				});
			});

			function highlightStars(value) {
				stars.forEach(star => {
					const val = star.dataset.value;
					if (val <= value) {
						star.setAttribute('fill', 'currentColor');
					} else {
						star.setAttribute('fill', 'none');
					}
				});
			}
		});
	</script>
}
